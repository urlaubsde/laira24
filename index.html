<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ù„ÙŠØ±Ø© 24</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#163300">
    <link rel="apple-touch-icon" href="./assets/icon.png">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .num-en {
            font-family: sans-serif;
            direction: ltr;
            display: inline-block;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .transition-all-300 {
            transition: all 0.3s ease-in-out;
        }
        /* Install Banner Animations */
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .install-banner {
            animation: slideDown 0.5s ease-out forwards;
        }

        /* Animations from original code */
        @keyframes pulse-green {
            0% { background-color: rgba(46, 208, 110, 0.2); }
            100% { background-color: transparent; }
        }
        @keyframes pulse-red {
            0% { background-color: rgba(239, 68, 68, 0.2); }
            100% { background-color: transparent; }
        }
        .animate-up { animation: pulse-green 1s ease-out; }
        .animate-down { animation: pulse-red 1s ease-out; }
        
        .chart-path {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: draw 1.5s ease-out forwards;
        }
        @keyframes draw {
            to { stroke-dashoffset: 0; }
        }

        .fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; visibility: hidden; }
        }
    </style>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#163300', 
                            primary: '#2ed06e',
                            light: '#9fe870',
                            bg: '#f3f4f6',
                            card: '#ffffff'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 text-gray-900 transition-colors duration-300">
    <div id="root"></div>

    <script>
        // ØªØ³Ø¬ÙŠÙ„ Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered!', reg))
                    .catch(err => console.log('SW Failed', err));
            });
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- Database Config ---
        // ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        const SUPABASE_URL = "https://xcmovzkbpumvufvmahew.supabase.co"; 
        const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjbW92emticHVtdnVmdm1haGV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MTc2MjYsImV4cCI6MjA3OTE5MzYyNn0.aLxh6TSQ6pznFoeWpgnbdDYv1eJBNKtcdonyLhzJUZs";
        
        // --- Global API Config ---
        const CURRENCY_API_KEY = "cur_live_CDxQbX4wFRag1Je6lH4NbngQ3ifR7dRF4bQR6azA";
        const GLOBAL_CACHE_DURATION = 45 * 60 * 1000;

        const SPREAD_PERCENTAGE = 0.005;

        const GLOBAL_DISPLAY_MAP = {
            USD: { name: "Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ", flag: "ğŸ‡ºğŸ‡¸" },
            EUR: { name: "ÙŠÙˆØ±Ùˆ", flag: "ğŸ‡ªğŸ‡º" },
            GBP: { name: "Ø¬Ù†ÙŠÙ‡ Ø¥Ø³ØªØ±Ù„ÙŠÙ†ÙŠ", flag: "ğŸ‡¬ğŸ‡§" },
            TRY: { name: "Ù„ÙŠØ±Ø© ØªØ±ÙƒÙŠØ©", flag: "ğŸ‡¹ğŸ‡·" },
            SAR: { name: "Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ", flag: "ğŸ‡¸ğŸ‡¦" },
            AED: { name: "Ø¯Ø±Ù‡Ù… Ø¥Ù…Ø§Ø±Ø§ØªÙŠ", flag: "ğŸ‡¦ğŸ‡ª" },
            KWD: { name: "Ø¯ÙŠÙ†Ø§Ø± ÙƒÙˆÙŠØªÙŠ", flag: "ğŸ‡°ğŸ‡¼" },
            QAR: { name: "Ø±ÙŠØ§Ù„ Ù‚Ø·Ø±ÙŠ", flag: "ğŸ‡¶ğŸ‡¦" },
            JOD: { name: "Ø¯ÙŠÙ†Ø§Ø± Ø£Ø±Ø¯Ù†ÙŠ", flag: "ğŸ‡¯ğŸ‡´" },
            CAD: { name: "Ø¯ÙˆÙ„Ø§Ø± ÙƒÙ†Ø¯ÙŠ", flag: "ğŸ‡¨ğŸ‡¦" },
            AUD: { name: "Ø¯ÙˆÙ„Ø§Ø± Ø£Ø³ØªØ±Ø§Ù„ÙŠ", flag: "ğŸ‡¦ğŸ‡º" },
            JPY: { name: "ÙŠÙ† ÙŠØ§Ø¨Ø§Ù†ÙŠ", flag: "ğŸ‡¯ğŸ‡µ" },
            RUB: { name: "Ø±ÙˆØ¨Ù„ Ø±ÙˆØ³ÙŠ", flag: "ğŸ‡·ğŸ‡º" },
            CNY: { name: "ÙŠÙˆØ§Ù† ØµÙŠÙ†ÙŠ", flag: "ğŸ‡¨ğŸ‡³" }
        };

        // ********** fetchSupabaseData FUNCTION **********
        async function fetchSupabaseData(viewName) {
            try {
                // Ù†Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ø¬Ù…Ø© (*) ÙÙ‚Ø· Ù„Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ù€ View
                const selectColumns = "*"; 

                // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù€ 'select' ÙƒÙ€ Query Parameter Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ø¶Ø§ÙØªÙ‡ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
                const url = `${SUPABASE_URL}/rest/v1/${viewName}?select=${selectColumns}`;
                
                const res = await fetch(url, { 
                    headers: {
                        "apikey": ANON_KEY,
                        "Authorization": "Bearer " + ANON_KEY
                    }
                });

                // ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø´Ø¨ÙƒØ© (Ù…Ø«Ù„ 404 Ø£Ùˆ 401)
                if (!res.ok) {
                    const errorText = await res.text();
                    // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø®Ø·Ø£ ÙƒØ§Ù…Ù„Ø§Ù‹ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„ØªØµØ­ÙŠØ­
                    console.error(`Supabase API Error for ${viewName}: ${res.status} - ${errorText}`);
                    return [];
                }

                return await res.json();
            } catch (error) {
                console.error("Error fetching data:", error);
                return [];
            }
        }
        // ********** END of fetchSupabaseData FUNCTION **********

        // --- Icons ---
        const Icons = {
            Home: () => <i data-lucide="home" className="w-6 h-6"></i>,
            Chart: () => <i data-lucide="bar-chart-2" className="w-6 h-6"></i>,
            Send: () => <i data-lucide="send" className="w-6 h-6"></i>,
            Coins: () => <i data-lucide="coins" className="w-6 h-6"></i>,
            Settings: () => <i data-lucide="settings" className="w-5 h-5"></i>,
            Globe: () => <i data-lucide="globe" className="w-6 h-6"></i>,
            ArrowRight: () => <i data-lucide="arrow-right" className="w-5 h-5"></i>,
            Refresh: () => <i data-lucide="refresh-cw" className="w-4 h-4"></i>,
            Moon: () => <i data-lucide="moon" className="w-5 h-5"></i>,
            Sun: () => <i data-lucide="sun" className="w-5 h-5"></i>,
            Check: () => <i data-lucide="check" className="w-4 h-4"></i>,
            Calculator: () => <i data-lucide="calculator" className="w-5 h-5"></i>,
            TrendUp: () => <i data-lucide="trending-up" className="w-3 h-3"></i>,
            TrendDown: () => <i data-lucide="trending-down" className="w-3 h-3"></i>,
            Minus: () => <i data-lucide="minus" className="w-3 h-3"></i>,
            Shield: () => <i data-lucide="shield-check" className="w-6 h-6"></i>,
            Zap: () => <i data-lucide="zap" className="w-6 h-6"></i>,
            Wallet: () => <i data-lucide="wallet" className="w-6 h-6"></i>,
            X: () => <i data-lucide="x" className="w-6 h-6"></i>,
            Clock: () => <i data-lucide="clock" className="w-4 h-4"></i>,
            Target: () => <i data-lucide="target" className="w-4 h-4"></i>,
            ArrowDownUp: () => <i data-lucide="arrow-up-down" className="w-4 h-4"></i>,
            Download: () => <i data-lucide="download" className="w-5 h-5"></i>
        };

        const IconRenderer = ({ icon }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });
            return <span className="inline-flex items-center justify-center icon-wrapper">
                {icon()}
            </span>;
        };

        // --- Chart Components ---
        const generateChartData = (basePrice, points = 20, volatility = 0.02) => {
            let data = [];
            let current = basePrice;
            for (let i = 0; i < points; i++) {
                if (i === points - 1) {
                    data.push(basePrice);
                } else {
                    const change = current * (Math.random() * volatility - (volatility / 2));
                    current += change;
                    data.push(current);
                }
            }
            return data;
        };

        const LineChart = ({ data, color = "#2ed06e" }) => {
            if (!data || data.length === 0) return null;
            const height = 120;
            const width = 300;
            const padding = 5;
            const min = Math.min(...data);
            const max = Math.max(...data);
            const range = max - min || 1;
            const points = data.map((val, i) => {
                const x = (i / (data.length - 1)) * width;
                const y = height - ((val - min) / range) * (height - padding * 2) - padding;
                return `${x},${y}`;
            }).join(' ');
            const areaPoints = `${points} ${width},${height} 0,${height}`;

            return (
                <div className="w-full h-40 relative select-none">
                    <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full overflow-visible">
                        <defs>
                            <linearGradient id="chartGradient" x1="0" x2="0" y1="0" y2="1">
                                <stop offset="0%" stopColor={color} stopOpacity="0.4" />
                                <stop offset="100%" stopColor={color} stopOpacity="0" />
                            </linearGradient>
                        </defs>
                        <path d={`M ${areaPoints}`} fill="url(#chartGradient)" stroke="none" />
                        <path d={`M ${points}`} fill="none" stroke={color} strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="chart-path" />
                        <circle cx={width} cy={height - ((data[data.length - 1] - min) / range) * (height - padding * 2) - padding} r="4" fill={color} stroke="white" strokeWidth="2" />
                    </svg>
                    <div className="absolute top-0 left-0 text-[10px] text-gray-400 font-mono bg-white/80 dark:bg-gray-800/80 px-1 rounded">High: {max.toLocaleString('en-US', {maximumFractionDigits: 0})}</div>
                    <div className="absolute bottom-0 left-0 text-[10px] text-gray-400 font-mono bg-white/80 dark:bg-gray-800/80 px-1 rounded">Low: {min.toLocaleString('en-US', {maximumFractionDigits: 0})}</div>
                </div>
            );
        };

        // --- Helpers ---
        const formatLastUpdate = (dateObj) => {
            if (!dateObj) return "Now";
            return dateObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        };

        // ********** calculateChange FUNCTION (Enhanced for DB previous_price) **********
        const calculateChange = (currentPrice, previousPrice) => {
            // Ù†ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ùˆ Ù„ÙŠØ³ null, undefined, Ø£Ùˆ 0
            if (previousPrice === null || previousPrice === undefined || parseFloat(previousPrice) === 0) {
                return { percent: 0, direction: 'neutral' };
            }

            const oldPrice = parseFloat(previousPrice);
            const current = parseFloat(currentPrice);
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ ØµÙØ±Ø§Ù‹ Ø£Ùˆ Ù„Ù… ÙŠØªØºÙŠØ±
            if (oldPrice === 0 || isNaN(oldPrice) || Math.abs(current - oldPrice) < 0.001) {
                return { percent: 0, direction: 'neutral' };
            }
            
            const diff = current - oldPrice;
            const percent = (diff / oldPrice) * 100;
            
            return { percent: Math.abs(percent).toFixed(2), direction: diff > 0 ? 'up' : 'down' };
        };
        // ********** END of calculateChange FUNCTION **********


        const getFlagAndCode = (name) => {
            if (name.includes("Ø¯ÙˆÙ„Ø§Ø±")) return { flag: "ğŸ‡ºğŸ‡¸", code: "USD" };
            if (name.includes("ÙŠÙˆØ±Ùˆ")) return { flag: "ğŸ‡ªğŸ‡º", code: "EUR" };
            if (name.includes("ØªØ±ÙƒÙŠ")) return { flag: "ğŸ‡¹ğŸ‡·", code: "TRY" };
            if (name.includes("Ø³Ø¹ÙˆØ¯ÙŠ")) return { flag: "ğŸ‡¸ğŸ‡¦", code: "SAR" };
            if (name.includes("Ø¥Ù…Ø§Ø±Ø§ØªÙŠ")) return { flag: "ğŸ‡¦ğŸ‡ª", code: "AED" };
            if (name.includes("Ø£Ø±Ø¯Ù†ÙŠ")) return { flag: "ğŸ‡¯ğŸ‡´", code: "JOD" };
            if (name.includes("Ù…ØµØ±ÙŠ")) return { flag: "ğŸ‡ªğŸ‡¬", code: "EGP" };
            if (name.includes("ÙƒÙˆÙŠØªÙŠ")) return { flag: "ğŸ‡°ğŸ‡¼", code: "KWD" };
            if (name.includes("Ø°Ù‡Ø¨")) return { flag: "ğŸ†", code: "GOLD" };
            return { flag: "ğŸŒ", code: "GBL" };
        };

        // --- Install Prompt Component (PWA) ---
        const InstallPrompt = () => {
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [showBanner, setShowBanner] = useState(false);

            useEffect(() => {
                const handler = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                    setShowBanner(true);
                };
                window.addEventListener('beforeinstallprompt', handler);
                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);

            const handleInstallClick = () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                        }
                        setDeferredPrompt(null);
                        setShowBanner(false);
                    });
                }
            };

            if (!showBanner) return null;

            return (
                <div className="fixed top-0 left-0 right-0 z-[60] p-4 install-banner">
                    <div className="bg-brand-dark text-white rounded-2xl shadow-2xl p-4 flex items-center justify-between border border-brand-primary/30">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-brand-primary rounded-xl flex items-center justify-center font-bold text-brand-dark">24</div>
                            <div>
                                <h3 className="font-bold text-sm">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù„ÙŠØ±Ø© 24</h3>
                                <p className="text-xs text-brand-light opacity-80">ØªØ«Ø¨ÙŠØª Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={() => setShowBanner(false)} className="p-2 text-gray-400 hover:text-white"><IconRenderer icon={Icons.X} /></button>
                            <button onClick={handleInstallClick} className="bg-brand-primary text-brand-dark px-4 py-2 rounded-xl text-xs font-bold hover:bg-white transition flex items-center gap-2">
                                <IconRenderer icon={Icons.Download} /> ØªØ«Ø¨ÙŠØª
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Splash Screen Component ---
        const SplashScreen = () => {
            return (
                <div className="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-brand-dark transition-all duration-500">
                     <div className="flex flex-col items-center animate-in fade-in zoom-in duration-700">
                        <div className="w-24 h-24 bg-brand-primary rounded-full flex items-center justify-center text-brand-dark font-bold text-4xl mb-6 shadow-2xl shadow-brand-primary/20 relative">
                             <div className="absolute inset-0 rounded-full border-4 border-white/10 animate-pulse"></div>
                            24
                        </div>
                        <h1 className="text-3xl font-bold text-white mb-2 tracking-wide">Ø§Ù„Ù„ÙŠØ±Ø© 24</h1>
                        <p className="text-brand-light text-sm opacity-90 font-light">Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨ ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Øª Ù„Ø­Ø¸Ø© Ø¨Ù„Ø­Ø¸Ø©</p>
                    </div>
                    <div className="absolute bottom-12">
                         <div className="flex gap-1">
                            <div className="w-2 h-2 bg-brand-primary rounded-full animate-bounce" style={{animationDelay: '0s'}}></div>
                            <div className="w-2 h-2 bg-brand-primary rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                            <div className="w-2 h-2 bg-brand-primary rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        function App() {
            const [showSplash, setShowSplash] = useState(true);
            const [activeTab, setActiveTab] = useState('home');
            const [currencyData, setCurrencyData] = useState([]);
            const [globalRawData, setGlobalRawData] = useState(null);
            const [baseCurrency, setBaseCurrency] = useState('USD');
            
            const [convAmount, setConvAmount] = useState(100);
            const [convFrom, setConvFrom] = useState('USD');
            const [convTo, setConvTo] = useState('EUR');
            
            const [goldData, setGoldData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [globalLoading, setGlobalLoading] = useState(false);
            const [darkMode, setDarkMode] = useState(false);
            
            const [goldCalcWeight, setGoldCalcWeight] = useState(''); 
            const [goldCalcFee, setGoldCalcFee] = useState('');       
            const [selectedGoldId, setSelectedGoldId] = useState(null);
            
            const [dbLastUpdate, setDbLastUpdate] = useState(new Date());
            const [apiLastUpdate, setApiLastUpdate] = useState(new Date());

            const [showGold, setShowGold] = useState(() => {
                const saved = localStorage.getItem('showGoldOnHome');
                return saved !== 'false'; 
            });

            const [pinned, setPinned] = useState(() => {
                try { return JSON.parse(localStorage.getItem('pinnedCurrencies')) || ['USD', 'EUR', 'TRY', 'SAR']; } 
                catch { return ['USD', 'EUR', 'TRY', 'SAR']; }
            });
            
            const [calcAmount, setCalcAmount] = useState(100);
            const [calcSource, setCalcSource] = useState(null);
            const [chartTimeframe, setChartTimeframe] = useState('1D');
            const [chartData, setChartData] = useState([]);

            useEffect(() => {
                const timer = setTimeout(() => {
                    setShowSplash(false);
                }, 3000);
                return () => clearTimeout(timer);
            }, []);

            useEffect(() => { localStorage.setItem('pinnedCurrencies', JSON.stringify(pinned)); }, [pinned]);
            useEffect(() => { localStorage.setItem('showGoldOnHome', showGold); }, [showGold]);

            useEffect(() => { loadData(); }, []);
            
            useEffect(() => {
                if (goldData.length > 0 && !selectedGoldId) {
                    setSelectedGoldId(goldData[0].id || goldData[0].description); 
                }
            }, [goldData]);

            useEffect(() => {
                if (calcSource) {
                    const base = parseFloat(calcSource.sell_price);
                    let points = 24; let volatility = 0.01;
                    switch(chartTimeframe) {
                        case '1D': points = 24; volatility = 0.005; break;
                        case '1W': points = 7; volatility = 0.015; break;
                        case '1M': points = 30; volatility = 0.03; break;
                        case '1Y': points = 12; volatility = 0.10; break;
                    }
                    setChartData(generateChartData(base, points, volatility));
                }
            }, [calcSource, chartTimeframe]);

            useEffect(() => { if (activeTab === 'global') fetchGlobalRates(); }, [activeTab]);
            useEffect(() => {
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [darkMode]);

            // ********** loadData FUNCTION (Uses DB previous_price) **********
            const loadData = async () => {
                setLoading(true);
                const [currencies, gold] = await Promise.all([
                    fetchSupabaseData("currency_rates_api"),
                    fetchSupabaseData("gold_rates_api")
                ]);

                const enrichedCurrencies = currencies.map(c => {
                    const { code } = getFlagAndCode(c.name);
                    const sellPrice = parseFloat(c.sell_price);
                    
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ù‚Ù„ previous_sell_price Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©
                    const previousSellPrice = c.previous_sell_price; 

                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ù† DB
                    const stats = calculateChange(sellPrice, previousSellPrice);
                    
                    return { ...c, stats, code };
                });

                const enrichedGold = gold.map(g => {
                    const sellPrice = parseFloat(g.sell_price);
                    
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ù‚Ù„ previous_sell_price Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©
                    const previousSellPrice = g.previous_sell_price;

                    const stats = calculateChange(sellPrice, previousSellPrice);
                    
                    return { ...g, stats };
                });

                setDbLastUpdate(new Date()); 

                setCurrencyData(enrichedCurrencies);
                setGoldData(enrichedGold);
                
                const usd = enrichedCurrencies.find(c => c.name.includes("Ø¯ÙˆÙ„Ø§Ø±"));
                if (usd) setCalcSource(usd);
                
                setLoading(false);
                if (window.lucide) setTimeout(() => window.lucide.createIcons(), 100);
            };
            // ********** END of loadData FUNCTION **********

            const fetchGlobalRates = async () => {
                const now = Date.now();
                const cachedGlobal = localStorage.getItem('globalRatesRaw');
                const lastGlobalFetch = localStorage.getItem('globalRatesTime');
                const cachedMeta = localStorage.getItem('globalRatesMeta');

                if (cachedGlobal && lastGlobalFetch && (now - parseInt(lastGlobalFetch) < GLOBAL_CACHE_DURATION)) {
                    setGlobalRawData(JSON.parse(cachedGlobal));
                    if (cachedMeta) {
                        try {
                            const meta = JSON.parse(cachedMeta);
                            if (meta.last_updated_at) {
                                setApiLastUpdate(new Date(meta.last_updated_at));
                            } else {
                                setApiLastUpdate(new Date(parseInt(lastGlobalFetch)));
                            }
                        } catch (e) {
                            setApiLastUpdate(new Date(parseInt(lastGlobalFetch)));
                        }
                    } else {
                        setApiLastUpdate(new Date(parseInt(lastGlobalFetch)));
                    }
                    return;
                }

                setGlobalLoading(true);
                try {
                    const res = await fetch(`https://api.currencyapi.com/v3/latest?apikey=${CURRENCY_API_KEY}&base_currency=USD`);
                    const result = await res.json();
                    if (result.data) {
                        setGlobalRawData(result.data);
                        localStorage.setItem('globalRatesRaw', JSON.stringify(result.data));
                        localStorage.setItem('globalRatesTime', now.toString());
                        
                        if (result.meta && result.meta.last_updated_at) {
                            setApiLastUpdate(new Date(result.meta.last_updated_at));
                            localStorage.setItem('globalRatesMeta', JSON.stringify(result.meta));
                        } else {
                            setApiLastUpdate(new Date(now));
                            localStorage.removeItem('globalRatesMeta');
                        }
                    }
                } catch (error) {
                    console.error("Error fetching global rates", error);
                }
                setGlobalLoading(false);
            };

            const togglePin = (code) => {
                const newPinned = pinned.includes(code) ? pinned.filter(c => c !== code) : [...pinned, code];
                setPinned(newPinned);
            };

            // --- UI Components ---
            const Header = ({ title, subtitle, time }) => (
                <div className="bg-brand-dark text-white p-6 pb-12 rounded-b-[2.5rem] shadow-lg relative z-10 mb-[-2rem]">
                    <div className="flex justify-between items-center mb-4">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-brand-primary rounded-full flex items-center justify-center text-brand-dark font-bold text-xs">24</div>
                            <h1 className="text-xl font-bold">Ø§Ù„Ù„ÙŠØ±Ø© 24</h1>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setActiveTab('settings')} className="p-2 bg-white/10 rounded-full hover:bg-white/20 transition"><IconRenderer icon={Icons.Settings} /></button>
                            <button onClick={loadData} className="p-2 bg-white/10 rounded-full hover:bg-white/20 transition group"><div className="group-active:rotate-180 transition-transform duration-500"><IconRenderer icon={Icons.Refresh} /></div></button>
                        </div>
                    </div>
                    <h2 className="text-2xl font-bold mb-1">{title}</h2>
                    <div className="flex items-center gap-2 text-brand-light text-sm opacity-90">
                        <span>{subtitle}</span><span className="w-1 h-1 rounded-full bg-brand-light"></span><span className="num-en font-mono text-xs opacity-80">ØªØ­Ø¯ÙŠØ«: {formatLastUpdate(time)}</span>
                    </div>
                </div>
            );

            const RateCard = ({ title, buy, sell, icon, code, stats }) => {
                const isUp = stats?.direction === 'up';
                const isDown = stats?.direction === 'down';
                return (
                    <div className={`bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 mb-3 flex items-center justify-between transition-all-300 hover:shadow-md ${isUp ? 'animate-up' : isDown ? 'animate-down' : ''}`}>
                        <div className="flex items-center gap-3">
                            <div className="w-12 h-12 rounded-full bg-gray-50 dark:bg-gray-700 flex items-center justify-center text-2xl shadow-inner relative">
                                {icon}
                                {stats && stats.direction !== 'neutral' && <div className={`absolute -bottom-1 -right-1 w-5 h-5 rounded-full border-2 border-white dark:border-gray-800 flex items-center justify-center text-[10px] font-bold ${isUp ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>{isUp ? 'â†‘' : 'â†“'}</div>}
                            </div>
                            <div>
                                <h3 className="font-bold text-gray-800 dark:text-white">{title}</h3>
                                <div className="flex items-center gap-2"><span className="text-xs text-gray-400 font-mono">{code}</span>{stats && <span className={`text-[10px] px-1.5 py-0.5 rounded flex items-center gap-1 font-bold num-en ${isUp ? 'text-green-600 bg-green-50' : isDown ? 'text-red-600 bg-red-50' : 'text-gray-400'}`}>{isUp ? <IconRenderer icon={Icons.TrendUp} /> : isDown ? <IconRenderer icon={Icons.TrendDown} /> : <IconRenderer icon={Icons.Minus} />}{stats.percent}%</span>}</div>
                            </div>
                        </div>
                        <div className="flex gap-4 text-left">
                            <div className="flex flex-col items-end"><span className="text-[10px] text-gray-400 uppercase tracking-wider">Ù…Ø¨ÙŠØ¹</span><span className={`font-bold text-lg num-en ${isDown ? 'text-red-500' : 'text-brand-dark dark:text-brand-light'}`}>{parseFloat(sell).toLocaleString('en-US', { maximumFractionDigits: 3 })}</span></div>
                            <div className="w-[1px] bg-gray-200 dark:bg-gray-600 h-8 self-center"></div>
                            <div className="flex flex-col items-end"><span className="text-[10px] text-gray-400 uppercase tracking-wider">Ø´Ø±Ø§Ø¡</span><span className={`font-bold text-lg num-en ${isUp ? 'text-green-500' : 'text-brand-primary'}`}>{parseFloat(buy).toLocaleString('en-US', { maximumFractionDigits: 3 })}</span></div>
                        </div>
                    </div>
                );
            };

            const renderHome = () => {
                const visibleCurrencies = currencyData.filter(c => pinned.includes(c.code)).sort((a, b) => pinned.indexOf(a.code) - pinned.indexOf(b.code));
                return (
                    <div className="pb-24">
                        <Header title="Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ø­Ø§Ù„ÙŠØ©" subtitle="Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù„ÙŠØ±Ø© Ø§Ù„Ø³ÙˆØ±ÙŠØ©" time={dbLastUpdate} />
                        <div className="px-4 pt-12">
                            {loading ? <div className="text-center py-10 text-gray-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div> : (
                                <>
                                    <div className="flex justify-between items-center mb-2 px-1"><span className="font-bold text-gray-700 dark:text-gray-200">Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…ÙØ¶Ù„Ø©</span><span className="text-xs text-brand-primary bg-brand-primary/10 px-2 py-1 rounded-full flex items-center gap-1"><span className="w-1.5 h-1.5 rounded-full bg-brand-primary animate-pulse"></span>Ù…Ø¨Ø§Ø´Ø±</span></div>
                                    {visibleCurrencies.length > 0 ? visibleCurrencies.map((c, i) => { const { flag } = getFlagAndCode(c.name); return <RateCard key={i} title={c.name} buy={c.buy_price} sell={c.sell_price} icon={flag} code={c.code} stats={c.stats} />; }) : <div className="text-center py-8 text-gray-400 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Øª Ù…Ø«Ø¨ØªØ©.</div>}
                                    
                                    {showGold && (
                                        <>
                                            <div className="flex justify-between items-center mb-2 px-1 mt-6"><span className="font-bold text-gray-700 dark:text-gray-200">Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨ (Ù…Ø®ØªØµØ±)</span></div>
                                            {goldData.slice(0, 2).map((g, i) => <RateCard key={`g-${i}`} title={g.description} buy={g.buy_price} sell={g.sell_price} icon="ğŸ†" code="GOLD" stats={g.stats} time={dbLastUpdate} />)}
                                        </>
                                    )}
                                </>
                            )}
                        </div>
                    </div>
                );
            };

            const renderGlobal = () => {
                let convResult = 0;
                if (globalRawData) {
                    const fromRate = convFrom === 'USD' ? 1 : globalRawData[convFrom]?.value || 1;
                    const toRate = convTo === 'USD' ? 1 : globalRawData[convTo]?.value || 1;
                    convResult = (convAmount / fromRate) * toRate;
                }
                let displayList = [];
                if (globalRawData) {
                    let conversionFactor = 1;
                    if (baseCurrency === 'EUR') {
                        const eurRate = globalRawData['EUR']?.value;
                        if (eurRate) conversionFactor = 1 / eurRate;
                    }
                    Object.keys(GLOBAL_DISPLAY_MAP).forEach(key => {
                        if (key === baseCurrency) return;
                        if (globalRawData[key]) {
                            const rawRate = globalRawData[key].value;
                            const baseRate = rawRate * conversionFactor;
                            const sell = baseRate * (1 + SPREAD_PERCENTAGE);
                            const buy = baseRate * (1 - SPREAD_PERCENTAGE);
                            displayList.push({ code: key, buy: buy, sell: sell, ...GLOBAL_DISPLAY_MAP[key] });
                        }
                    });
                }

                return (
                    <div className="pb-24">
                        <Header title="Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©" subtitle="ØªØ­ÙˆÙŠÙ„ ÙˆØ­Ø§Ø³Ø¨Ø© ÙÙˆØ±ÙŠØ©" time={apiLastUpdate} />
                        <div className="px-4 pt-12">
                            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 p-5 mb-8 relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-1 bg-brand-primary"></div>
                                <h3 className="text-sm font-bold text-gray-500 mb-4 flex items-center gap-2"><IconRenderer icon={Icons.Calculator} />Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©</h3>
                                <div className="flex gap-3 mb-4">
                                    <div className="flex-1"><label className="text-[10px] text-gray-400 mb-1 block">Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" value={convAmount} onChange={(e) => setConvAmount(e.target.value)} className="w-full bg-gray-50 dark:bg-gray-700 rounded-lg p-3 font-bold text-lg outline-none border focus:border-brand-primary dark:text-white num-en" /></div>
                                </div>
                                <div className="flex items-center gap-2 mb-4">
                                    <div className="flex-1"><label className="text-[10px] text-gray-400 mb-1 block">Ù…Ù†</label><select value={convFrom} onChange={(e) => setConvFrom(e.target.value)} className="w-full bg-gray-50 dark:bg-gray-700 rounded-lg p-2 text-sm font-bold outline-none dark:text-white"><option value="USD">ğŸ‡ºğŸ‡¸ USD</option>{Object.keys(GLOBAL_DISPLAY_MAP).map(k => <option key={k} value={k}>{GLOBAL_DISPLAY_MAP[k].flag} {k}</option>)}</select></div>
                                    <button onClick={() => { const temp = convFrom; setConvFrom(convTo); setConvTo(temp); }} className="mt-4 w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-600 flex items-center justify-center text-gray-500 hover:bg-brand-primary hover:text-white transition"><div className="rotate-90"><IconRenderer icon={Icons.ArrowDownUp} /></div></button>
                                    <div className="flex-1"><label className="text-[10px] text-gray-400 mb-1 block">Ø¥Ù„Ù‰</label><select value={convTo} onChange={(e) => setConvTo(e.target.value)} className="w-full bg-gray-50 dark:bg-gray-700 rounded-lg p-2 text-sm font-bold outline-none dark:text-white"><option value="USD">ğŸ‡ºğŸ‡¸ USD</option>{Object.keys(GLOBAL_DISPLAY_MAP).map(k => <option key={k} value={k}>{GLOBAL_DISPLAY_MAP[k].flag} {k}</option>)}</select></div>
                                </div>
                                <div className="bg-brand-bg dark:bg-gray-900/50 rounded-xl p-3 flex flex-col items-center justify-center border border-dashed border-gray-300 dark:border-gray-600"><span className="text-xs text-gray-400">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©</span><div className="text-2xl font-bold text-brand-dark dark:text-brand-primary num-en mt-1">{convResult.toLocaleString('en-US', { maximumFractionDigits: 2 })} <span className="text-xs ml-1 text-gray-500">{convTo}</span></div></div>
                            </div>
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="font-bold text-gray-700 dark:text-gray-200">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h3>
                                <div className="flex bg-gray-200 dark:bg-gray-700 rounded-lg p-0.5">
                                    <button onClick={() => setBaseCurrency('USD')} className={`px-3 py-1 rounded-md text-xs font-bold transition ${baseCurrency === 'USD' ? 'bg-white dark:bg-gray-600 shadow text-brand-dark dark:text-white' : 'text-gray-500'}`}>USD ($)</button>
                                    <button onClick={() => setBaseCurrency('EUR')} className={`px-3 py-1 rounded-md text-xs font-bold transition ${baseCurrency === 'EUR' ? 'bg-white dark:bg-gray-600 shadow text-brand-dark dark:text-white' : 'text-gray-500'}`}>EUR (â‚¬)</button>
                                </div>
                            </div>
                            {globalLoading && !globalRawData ? <div className="text-center py-10 text-gray-400">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±...</div> : (
                                <>
                                    {displayList.map((curr, i) => <RateCard key={i} title={curr.name} buy={curr.buy} sell={curr.sell} icon={curr.flag} code={curr.code} />)}
                                    <p className="text-center text-xs text-gray-400 mt-4">Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¹Ø§Ù„Ù…ÙŠØ© ÙˆÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ ÙƒÙ„ 45 Ø¯Ù‚ÙŠÙ‚Ø©.</p>
                                </>
                            )}
                        </div>
                    </div>
                );
            };

            const renderGold = () => {
                const activeGold = goldData.find(g => (g.id || g.description) === selectedGoldId) || goldData[0];
                const weight = parseFloat(goldCalcWeight) || 0;
                const fee = parseFloat(goldCalcFee) || 0;
                const goldPrice = activeGold ? parseFloat(activeGold.sell_price) : 0;
                const rawTotal = weight * goldPrice;
                const feeTotal = weight * fee;
                const finalTotal = rawTotal + feeTotal;

                return (
                    <div className="pb-24">
                        <Header title="Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨ ÙˆØ§Ù„Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª" subtitle="ØªØ­Ø¯ÙŠØ« Ù„Ø­Ø¸ÙŠ Ù…Ù† Ø§Ù„ØµØ§ØºØ©" time={dbLastUpdate} />
                        <div className="px-4 pt-12">
                            {loading ? <div className="text-center py-10">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div> : (
                                <>
                                    <div className="mb-8 space-y-3">
                                         {goldData.map((g, i) => (
                                            <RateCard key={i} title={g.description} buy={g.buy_price} sell={g.sell_price} icon="âœ¨" code={`K${24-i}`} stats={g.stats} />
                                        ))}
                                    </div>
                                    <div className="bg-white dark:bg-gray-800 rounded-[2rem] shadow-xl border border-gray-100 dark:border-gray-700 overflow-hidden relative animate-in fade-in slide-in-from-bottom-4 duration-700">
                                        <div className="bg-brand-dark p-5 relative overflow-hidden">
                                            <div className="absolute top-0 right-0 w-32 h-32 bg-brand-primary/10 rounded-full blur-2xl translate-x-10 -translate-y-10"></div>
                                            <h3 className="text-white font-bold text-lg flex items-center gap-2 relative z-10">
                                                <div className="p-1.5 bg-brand-primary rounded-lg text-brand-dark"><IconRenderer icon={Icons.Calculator} /></div>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø°Ù‡Ø¨ ÙˆØ§Ù„Ù…ØµÙ†Ø¹ÙŠØ©
                                            </h3>
                                            <p className="text-brand-light/80 text-xs mt-1 mr-10 relative z-10">Ø­Ø³Ø§Ø¨ Ø¯Ù‚ÙŠÙ‚ ÙŠØ´Ù…Ù„ Ø§Ù„ÙˆØ²Ù† ÙˆØ£Ø¬Ø±Ø© Ø§Ù„ØµÙŠØ§ØºØ©</p>
                                        </div>
                                        <div className="p-5">
                                            <div className="mb-4">
                                                <label className="text-xs font-bold text-gray-500 mb-2 block px-1">Ø¹ÙŠØ§Ø± Ø§Ù„Ø°Ù‡Ø¨</label>
                                                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                                                    {goldData.map((g, i) => {
                                                        const isActive = (g.id || g.description) === (activeGold?.id || activeGold?.description);
                                                        return (
                                                            <button key={i} onClick={() => setSelectedGoldId(g.id || g.description)} className={`flex-shrink-0 px-4 py-2 rounded-xl text-sm font-bold transition-all duration-300 border ${isActive ? 'bg-brand-primary text-brand-dark border-brand-primary shadow-lg shadow-brand-primary/30' : 'bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-300 border-gray-200 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600'}`}>{g.description}</button>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4 mb-6">
                                                <div className="bg-gray-50 dark:bg-gray-900/50 rounded-2xl p-3 border border-gray-100 dark:border-gray-700 focus-within:border-brand-primary focus-within:ring-1 focus-within:ring-brand-primary transition-all">
                                                    <label className="text-[10px] text-gray-400 block mb-1">Ø§Ù„ÙˆØ²Ù† (ØºØ±Ø§Ù…)</label>
                                                    <div className="flex items-center justify-between"><input type="number" value={goldCalcWeight} onChange={(e) => setGoldCalcWeight(e.target.value)} placeholder="0" className="w-full bg-transparent font-bold text-xl text-brand-dark dark:text-white outline-none num-en placeholder-gray-300" /><span className="text-xs font-bold text-gray-400 bg-white dark:bg-gray-700 px-2 py-1 rounded-md shadow-sm">gm</span></div>
                                                </div>
                                                <div className="bg-gray-50 dark:bg-gray-900/50 rounded-2xl p-3 border border-gray-100 dark:border-gray-700 focus-within:border-brand-primary focus-within:ring-1 focus-within:ring-brand-primary transition-all">
                                                    <label className="text-[10px] text-gray-400 block mb-1">Ø§Ù„Ù…ØµÙ†Ø¹ÙŠØ© (Ù„Ù„ØºØ±Ø§Ù…)</label>
                                                    <div className="flex items-center justify-between"><input type="number" value={goldCalcFee} onChange={(e) => setGoldCalcFee(e.target.value)} placeholder="0" className="w-full bg-transparent font-bold text-xl text-brand-dark dark:text-white outline-none num-en placeholder-gray-300" /><span className="text-xs font-bold text-gray-400 bg-white dark:bg-gray-700 px-2 py-1 rounded-md shadow-sm">Ù„.Ø³</span></div>
                                                </div>
                                            </div>
                                            <div className="bg-gradient-to-br from-brand-bg to-white dark:from-gray-700 dark:to-gray-800 rounded-2xl p-4 border border-dashed border-brand-primary/30 relative">
                                                <div className="flex justify-between items-end mb-2"><span className="text-xs text-gray-500 dark:text-gray-400">Ø³Ø¹Ø± Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ø®Ø§Ù…</span><span className="font-mono text-sm text-gray-700 dark:text-gray-300 num-en">{rawTotal.toLocaleString('en-US')}</span></div>
                                                {fee > 0 && (<div className="flex justify-between items-end mb-3 pb-3 border-b border-gray-200 dark:border-gray-600"><span className="text-xs text-gray-500 dark:text-gray-400">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµÙ†Ø¹ÙŠØ©</span><span className="font-mono text-sm text-gray-700 dark:text-gray-300 num-en">{feeTotal.toLocaleString('en-US')}</span></div>)}
                                                <div className="flex justify-between items-center pt-1">
                                                    <div><p className="text-xs font-bold text-brand-dark dark:text-brand-light mb-0.5">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ</p><p className="text-[10px] text-gray-400">ÙŠØ®ØªÙ„Ù Ø§Ù„Ø³Ø¹Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø­Ù„Ø§Øª</p></div>
                                                    <div className="text-right"><span className="block text-2xl font-black text-brand-primary num-en tracking-tight">{finalTotal > 0 ? finalTotal.toLocaleString('en-US') : '0'}</span><span className="text-[10px] font-bold text-gray-400 uppercase">Ù„ÙŠØ±Ø© Ø³ÙˆØ±ÙŠØ©</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                );
            };

            const renderCalculator = () => {
                const isTrendUp = chartData.length > 0 && chartData[chartData.length - 1] > chartData[0];
                const chartColor = isTrendUp ? "#2ed06e" : "#ef4444";
                return (
                    <div className="pb-24">
                        <Header title="Ø§Ù„Ø­Ø§Ø³Ø¨Ø© ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª" subtitle="Ø­Ø³Ø§Ø¨ Ø¯Ù‚ÙŠÙ‚ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Øª" time={dbLastUpdate} />
                        <div className="px-4 pt-12">
                            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6 border border-gray-100 dark:border-gray-700 mb-4">
                                <label className="block text-sm text-gray-500 mb-2 font-semibold">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­ÙˆÙŠÙ„Ù‡</label>
                                <div className="relative mb-6"><input type="number" value={calcAmount} onChange={(e) => setCalcAmount(e.target.value)} className="w-full text-3xl font-bold text-brand-dark dark:text-white bg-transparent border-b-2 border-gray-200 focus:border-brand-primary outline-none py-2 num-en" /></div>
                                <label className="block text-sm text-gray-500 mb-2 font-semibold">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„Ø©</label>
                                <div className="grid grid-cols-2 gap-2 mb-4 max-h-40 overflow-y-auto no-scrollbar">
                                    {currencyData.map((c, i) => {
                                         const { flag, code } = getFlagAndCode(c.name);
                                         const isSelected = calcSource?.name === c.name;
                                         return <button key={i} onClick={() => setCalcSource(c)} className={`flex items-center gap-2 p-2 rounded-lg border transition ${isSelected ? 'border-brand-primary bg-brand-primary/10' : 'border-gray-200 dark:border-gray-700'}`}><span>{flag}</span><span className="text-sm font-bold dark:text-gray-200">{code}</span></button>;
                                    })}
                                </div>
                                {calcSource && <div className="bg-gray-50 dark:bg-gray-700/50 rounded-xl p-4 text-center"><p className="text-gray-500 text-sm mb-1">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„Ù„ÙŠØ±Ø© Ø§Ù„Ø³ÙˆØ±ÙŠØ©</p><div className="text-3xl font-bold text-brand-primary num-en">{Math.floor(calcAmount * calcSource.sell_price).toLocaleString('en-US')} <span className="text-sm mr-1 text-gray-400">Ù„.Ø³</span></div></div>}
                            </div>
                            {calcSource && (
                                <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden animate-in fade-in slide-in-from-bottom-4 duration-500">
                                    <div className="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
                                        <div className="flex items-center gap-2"><div className={`p-1.5 rounded-lg ${isTrendUp ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}><IconRenderer icon={isTrendUp ? Icons.TrendUp : Icons.TrendDown} /></div><div><h3 className="font-bold text-sm dark:text-white">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø±</h3><p className="text-[10px] text-gray-400">{calcSource.name}</p></div></div>
                                        <div className="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-0.5">{['1D', '1W', '1M', '1Y'].map(tf => <button key={tf} onClick={() => setChartTimeframe(tf)} className={`px-3 py-1 text-xs font-bold rounded-md transition ${chartTimeframe === tf ? 'bg-white dark:bg-gray-600 shadow text-brand-primary' : 'text-gray-400 hover:text-gray-600'}`}>{tf === '1D' ? 'ÙŠÙˆÙ…' : tf === '1W' ? 'Ø£Ø³Ø¨ÙˆØ¹' : tf === '1M' ? 'Ø´Ù‡Ø±' : 'Ø³Ù†Ø©'}</button>)}</div>
                                    </div>
                                    <div className="p-4 relative"><LineChart data={chartData} color={chartColor} /></div>
                                    <div className="bg-gray-50 dark:bg-gray-700/30 p-3 flex justify-between text-xs text-gray-500 dark:text-gray-400 px-6">
                                        <div className="flex items-center gap-1"><IconRenderer icon={Icons.Target} /><span>Ù…Ø¤Ø´Ø± Ø§Ù„Ø§ÙØªØªØ§Ø­: <span className="font-bold num-en">{chartData[0]?.toLocaleString('en-US', {maximumFractionDigits:0})}</span></span></div>
                                        <div className="flex items-center gap-1"><IconRenderer icon={Icons.Clock} /><span>Ø§Ù„Ø¥ØºÙ„Ø§Ù‚: <span className="font-bold num-en">{chartData[chartData.length-1]?.toLocaleString('en-US', {maximumFractionDigits:0})}</span></span></div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const renderSettings = () => (
                <div className="pb-24">
                    <Header title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª" subtitle="ØªØ®ØµÙŠØµ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚" time={dbLastUpdate} />
                    <div className="px-4 pt-12 space-y-4">
                        <div className="bg-white dark:bg-gray-800 rounded-xl p-4 flex justify-between items-center shadow-sm">
                            <div className="flex items-center gap-3"><div className={`p-2 rounded-full ${darkMode ? 'bg-indigo-100 text-indigo-600' : 'bg-yellow-100 text-yellow-600'}`}><IconRenderer icon={darkMode ? Icons.Moon : Icons.Sun} /></div><span className="font-bold dark:text-white">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span></div>
                            <button onClick={() => setDarkMode(!darkMode)} className={`w-12 h-6 rounded-full transition-colors flex items-center px-1 ${darkMode ? 'bg-brand-primary justify-end' : 'bg-gray-300 justify-start'}`}><div className="w-4 h-4 bg-white rounded-full shadow-md"></div></button>
                        </div>
                        <div className="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm">
                            <h3 className="font-bold mb-4 border-b pb-2 dark:border-gray-700 dark:text-white">ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</h3>
                            <div onClick={() => setShowGold(!showGold)} className="flex justify-between items-center cursor-pointer p-2 mb-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg">
                                <div className="flex items-center gap-3"><span className="text-xl">ğŸ†</span><span className="dark:text-gray-200">Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨</span></div>
                                <div className={`w-5 h-5 rounded-full border flex items-center justify-center transition-colors ${showGold ? 'bg-brand-primary border-brand-primary text-white' : 'border-gray-300'}`}>{showGold && <IconRenderer icon={Icons.Check} />}</div>
                            </div>
                             <h4 className="font-bold text-sm text-gray-500 mt-4 mb-2">Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ©</h4>
                            <div className="space-y-3">{currencyData.map((c, i) => { const { flag } = getFlagAndCode(c.name); const code = c.code; const isPinned = pinned.includes(code); return <div key={i} onClick={() => togglePin(code)} className="flex justify-between items-center cursor-pointer p-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg"><div className="flex items-center gap-3"><span className="text-xl">{flag}</span><span className="dark:text-gray-200">{c.name}</span></div><div className={`w-5 h-5 rounded-full border flex items-center justify-center transition-colors ${isPinned ? 'bg-brand-primary border-brand-primary text-white' : 'border-gray-300'}`}>{isPinned && <IconRenderer icon={Icons.Check} />}</div></div>; })}</div>
                        </div>
                    </div>
                </div>
            );

            const renderTransfer = () => (
                <div className="fixed inset-0 bg-gray-900 z-50 flex flex-col animate-in fade-in duration-300 overflow-y-auto no-scrollbar">
                    <div className="flex justify-between items-center p-6"><h2 className="text-2xl font-bold text-white">Ø§Ù„Ø­ÙˆØ§Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h2><button onClick={() => setActiveTab('home')} className="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-gray-400 hover:bg-gray-700 transition"><IconRenderer icon={Icons.X} /></button></div>
                    <div className="flex-1 px-6 pb-8 flex flex-col items-center">
                        <div className="w-full bg-gradient-to-br from-brand-dark to-[#0f2400] rounded-3xl p-6 mb-6 relative overflow-hidden border border-gray-700 shadow-2xl">
                            <div className="absolute top-0 right-0 w-32 h-32 bg-brand-primary/10 rounded-full blur-3xl translate-x-10 -translate-y-10"></div>
                            <div className="relative z-10 flex flex-col items-center text-center"><div className="w-16 h-16 bg-brand-primary/20 rounded-2xl flex items-center justify-center mb-4 border border-brand-primary/30 backdrop-blur-sm"><span className="text-3xl text-brand-primary">â‚®</span></div><h3 className="text-white text-xl font-bold mb-1">Ù†Ù‚Ø¨Ù„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø±Ù‚Ù…ÙŠ</h3><p className="text-brand-primary text-sm font-mono bg-brand-primary/10 px-3 py-1 rounded-full border border-brand-primary/20 mb-4">USDT (TRC20) Supported</p><p className="text-gray-300 text-sm leading-relaxed">Ø­ÙˆÙ‘Ù„ Ø£Ù…ÙˆØ§Ù„Ùƒ Ù…Ù† Ø£ÙŠ Ù…ÙƒØ§Ù† ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù… Ø¥Ù„Ù‰ Ø³ÙˆØ±ÙŠØ§ ÙˆÙƒØ§ÙØ© Ø£Ù†Ø­Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù„Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©. Ø§Ø³ØªÙ„Ø§Ù… ÙÙˆØ±ÙŠ ÙˆØ¢Ù…Ù†.</p></div>
                        </div>
                        <div className="grid grid-cols-2 gap-3 w-full mb-8">
                            <div className="bg-gray-800/50 p-4 rounded-2xl border border-gray-700/50 flex flex-col items-center text-center gap-2"><div className="text-blue-400"><IconRenderer icon={Icons.Shield} /></div><span className="text-gray-200 font-bold text-sm">Ø¢Ù…Ù† 100%</span></div>
                            <div className="bg-gray-800/50 p-4 rounded-2xl border border-gray-700/50 flex flex-col items-center text-center gap-2"><div className="text-yellow-400"><IconRenderer icon={Icons.Zap} /></div><span className="text-gray-200 font-bold text-sm">ØªØ­ÙˆÙŠÙ„ Ù„Ø­Ø¸ÙŠ</span></div>
                            <div className="bg-gray-800/50 p-4 rounded-2xl border border-gray-700/50 flex flex-col items-center text-center gap-2"><div className="text-green-400"><IconRenderer icon={Icons.Wallet} /></div><span className="text-gray-200 font-bold text-sm">Ø¹Ù…ÙˆÙ„Ø§Øª Ù…Ù†Ø§ÙØ³Ø©</span></div>
                            <div className="bg-gray-800/50 p-4 rounded-2xl border border-gray-700/50 flex flex-col items-center text-center gap-2"><div className="text-purple-400"><IconRenderer icon={Icons.Globe} /></div><span className="text-gray-200 font-bold text-sm">ØªØºØ·ÙŠØ© Ø´Ø§Ù…Ù„Ø©</span></div>
                        </div>
                        <div className="w-full mt-auto"><p className="text-center text-gray-400 text-xs mb-4">ÙŠØªÙ… ØªÙ†ÙÙŠØ° Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­ÙˆØ§Ù„Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¹Ø¨Ø± ÙØ±ÙŠÙ‚ Ø§Ù„Ø¯Ø¹Ù… Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø£Ù…Ø§Ù†</p><a href="https://t.me/Lairas24" target="_blank" className="group w-full bg-brand-primary hover:bg-green-400 text-brand-dark font-bold py-4 rounded-xl flex items-center justify-center gap-3 transition-all duration-300 shadow-[0_0_20px_rgba(46,208,110,0.3)] hover:shadow-[0_0_30px_rgba(46,208,110,0.5)]"><svg className="w-6 h-6 transition-transform group-hover:-translate-y-1 group-hover:translate-x-1" viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0 12 12c0 6.627-5.373 12-12 12S0 18.627 0 12 5.373 0 12 0Zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635Z"/></svg><span className="text-lg">Ø¨Ø¯Ø¡ ØªØ­ÙˆÙŠÙ„ USDT</span></a></div>
                    </div>
                </div>
            );

            const NavBar = () => (
                <div className="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-800 pb-safe pt-2 px-6 flex justify-between items-end h-[80px] z-40 shadow-[0_-5px_10px_rgba(0,0,0,0.02)]">
                    <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-1 pb-4 w-12 transition ${activeTab === 'home' ? 'text-brand-primary' : 'text-gray-400'}`}><IconRenderer icon={Icons.Home} /><span className="text-[10px] font-medium">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></button>
                    <button onClick={() => setActiveTab('calc')} className={`flex flex-col items-center gap-1 pb-4 w-12 transition ${activeTab === 'calc' ? 'text-brand-primary' : 'text-gray-400'}`}><IconRenderer icon={Icons.Chart} /><span className="text-[10px] font-medium">Ø­Ø§Ø³Ø¨Ø©</span></button>
                    <div className="relative -top-8"><button onClick={() => setActiveTab('transfer')} className="w-14 h-14 bg-brand-primary hover:bg-brand-light text-brand-dark rounded-full flex items-center justify-center shadow-lg shadow-brand-primary/40 transition-transform hover:scale-105"><IconRenderer icon={Icons.Send} /></button></div>
                    <button onClick={() => setActiveTab('gold')} className={`flex flex-col items-center gap-1 pb-4 w-12 transition ${activeTab === 'gold' ? 'text-brand-primary' : 'text-gray-400'}`}><IconRenderer icon={Icons.Coins} /><span className="text-[10px] font-medium">Ø§Ù„Ø°Ù‡Ø¨</span></button>
                    <button onClick={() => setActiveTab('global')} className={`flex flex-col items-center gap-1 pb-4 w-12 transition ${activeTab === 'global' ? 'text-brand-primary' : 'text-gray-400'}`}><IconRenderer icon={Icons.Globe} /><span className="text-[10px] font-medium">Ø¹Ù…Ù„Ø§Øª</span></button>
                </div>
            );

            return (
                <div className="min-h-screen bg-gray-100 dark:bg-gray-900 max-w-md mx-auto relative shadow-2xl overflow-hidden">
                    <InstallPrompt /> {/* Install Banner Component */}
                    {showSplash && <SplashScreen />}
                    
                    {activeTab === 'home' && renderHome()}
                    {activeTab === 'gold' && renderGold()}
                    {activeTab === 'calc' && renderCalculator()}
                    {activeTab === 'settings' && renderSettings()}
                    {activeTab === 'transfer' && renderTransfer()}
                    {activeTab === 'global' && renderGlobal()}
                    {activeTab !== 'transfer' && <NavBar />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
